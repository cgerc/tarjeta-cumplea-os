<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitaci√≥n Cumplea√±os Sonic</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* TODO TU CSS ORIGINAL (lo dejo igual que antes, no lo repito para no alargar) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial Black', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e22ce 100%); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; overflow-x: hidden; overflow-y: auto; position: relative; padding: 20px 0; }
        .stars { position: absolute; width: 100%; height: 100%; overflow: hidden; }
        .star { position: absolute; width: 3px; height: 3px; background: white; border-radius: 50%; animation: twinkle 2s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        .container { background: linear-gradient(145deg, #0066ff, #0052cc); border-radius: 30px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), inset 0 -5px 20px rgba(255, 255, 255, 0.2); position: relative; z-index: 10; border: 5px solid #ffd700; margin: 20px auto; }
        /* ... todo tu CSS original (mant√©nlo igual) ... */
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="container">
        <!-- TODO TU HTML ORIGINAL (invitaci√≥n, formulario, lista, botones) -->
        <!-- Lo dejo igual que tu c√≥digo original, solo agrego el ID correcto para la lista -->
        <!-- ... tu HTML completo ... -->

        <div class="form-container" id="formContainer">
            <!-- formulario -->
        </div>

        <div class="guest-list hidden" id="guestList">
            <h3>üéä Lista de Invitados Confirmados</h3>
            <div id="guestItems"></div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="button" onclick="verInvitados()">üë• VER INVITADOS</button>
            <button class="button" onclick="descargarExcel()" style="background: linear-gradient(135deg, #00cc00, #00aa00);">üì• DESCARGAR EXCEL</button>
        </div>
    </div>

    <!-- M√∫sica y audio -->
    <div class="music-control" id="musicControl" onclick="toggleMusic()">
        <span class="music-icon" id="musicIcon">üéµ</span>
    </div>
    <audio id="backgroundMusic" loop>
        <source src="https://cdn.freesound.org/previews/442/442127_5121236-lq.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ====== FIREBASE CONFIG ======
        const firebaseConfig = {
          apiKey: "AIzaSyD5goNmwrAVseZlhBNLaCU7qfKZCs5sThY",
          authDomain: "tarjeta-cumple-c774c.firebaseapp.com",
          projectId: "tarjeta-cumple-c774c",
          storageBucket: "tarjeta-cumple-c774c.firebaseapp.com",
          messagingSenderId: "272528438834",
          appId: "1:272528438834:web:5b3c7cde927b14f4a6ee2b",
          measurementId: "G-F7T3LM57WB"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const invitadosRef = db.collection('invitados');

        let guests = [];
        let musicPlaying = false;
        const music = document.getElementById('backgroundMusic');
        const musicControl = document.getElementById('musicControl');
        const musicIcon = document.getElementById('musicIcon');

        // M√∫sica
        function toggleMusic() {
            if (musicPlaying) {
                music.pause();
                musicIcon.textContent = 'üéµ';
                musicControl.classList.remove('playing');
            } else {
                music.play().catch(() => console.log('Autoplay bloqueado'));
                musicIcon.textContent = 'üîä';
                musicControl.classList.add('playing');
            }
            musicPlaying = !musicPlaying;
        }

        window.addEventListener('load', () => {
            music.volume = 0.3;
            music.play().catch(() => console.log('Autoplay bloqueado'));
            cargarInvitadosDesdeFirebase(); // Carga desde Firebase
            crearEstrellas();
        });

        function crearEstrellas() {
            const starsContainer = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                starsContainer.appendChild(star);
            }
        }

        function createConfetti() {
            const colors = ['#ff0000', '#ffd700', '#0066ff', '#00ff00', '#ff00ff'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.opacity = '1';
                    confetti.style.animation = `confetti-fall ${2 + Math.random() * 2}s linear forwards`;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // Confirmar asistencia (guardar en Firebase)
        async function confirmarAsistencia() {
            const name = document.getElementById('guestName').value.trim();
            const hasCar = document.getElementById('hasCar').checked;
            const dietary = document.getElementById('dietary').value.trim();

            if (!name) {
                alert('Por favor ingresa tu nombre');
                return;
            }

            try {
                await invitadosRef.add({
                    name: name,
                    hasCar: hasCar,
                    dietary: dietary || 'Ninguna',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                const message = document.getElementById('confirmMessage');
                message.classList.remove('hidden');
                createConfetti();

                document.getElementById('guestName').value = '';
                document.getElementById('hasCar').checked = false;
                document.getElementById('dietary').value = '';

                setTimeout(() => message.classList.add('hidden'), 3000);
            } catch (error) {
                alert('Error al confirmar. Abre la consola (F12) para ver el error.');
                console.error(error);
            }
        }

        // Cargar invitados desde Firebase en tiempo real
        function cargarInvitadosDesdeFirebase() {
            invitadosRef.orderBy('timestamp', 'desc').onSnapshot(snapshot => {
                guests = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    guests.push({
                        name: data.name,
                        hasCar: data.hasCar,
                        dietary: data.dietary
                    });
                });
                actualizarListaInvitados();
            }, error => {
                console.error('Error cargando invitados:', error);
            });
        }

        function actualizarListaInvitados() {
            const guestItems = document.getElementById('guestItems');
            guestItems.innerHTML = '';

            guests.forEach(guest => {
                const item = document.createElement('div');
                item.className = 'guest-item';
                item.innerHTML = `
                    <p><strong>${guest.name}</strong></p>
                    <p>üöó Viene en auto: ${guest.hasCar ? 'S√≠' : 'No'}</p>
                    <p>üçΩÔ∏è Restricciones: ${guest.dietary}</p>
                `;
                guestItems.appendChild(item);
            });
        }

        function verInvitados() {
            const guestList = document.getElementById('guestList');
            if (guests.length === 0) {
                alert('A√∫n no hay invitados confirmados');
                return;
            }
            guestList.classList.toggle('hidden');
        }

        function descargarExcel() {
            if (guests.length === 0) {
                alert('No hay invitados para descargar');
                return;
            }

            const datosExcel = guests.map((guest, index) => ({
                'N¬∞': index + 1,
                'Nombre': guest.name,
                'Viene en Auto': guest.hasCar ? 'S√≠' : 'No',
                'Restricciones Alimentarias': guest.dietary
            }));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(datosExcel);
            ws['!cols'] = [{ wch: 5 }, { wch: 30 }, { wch: 15 }, { wch: 40 }];
            XLSX.utils.book_append_sheet(wb, ws, 'Invitados');

            const fecha = new Date().toLocaleDateString('es-CL').replace(/\//g, '-');
            XLSX.writeFile(wb, `Invitados_Cumplea√±os_Santino_${fecha}.xlsx`);
        }
    </script>
</body>
</html>